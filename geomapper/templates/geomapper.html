{% extends "base.html" %}
{% block content %}
<style>
    #map {width: 100%; height: 500px;}
</style>
<div class="map-container">
    <h2>Narysuj geometrię</h2>
    <p>Użyj narzędzi po lewej stronie, aby narysować punkt, linię lub poligon.</p>
    <div id="map"></div>
    <div id="toast" class="toast"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Inicjalizacja mapy
    const map = L.map('map').setView([52.2297, 21.0122], 13);

    // Warstwa bazowa OSM
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Wymuszenie przeliczenia rozmiaru mapy po inicjalizacji
    setTimeout(function() {
        map.invalidateSize();
    }, 100);

    // Warstwa do przechowywania narysowanych obiektów
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // Konfiguracja narzędzi do rysowania
    const drawControl = new L.Control.Draw({
        edit: {
            featureGroup: drawnItems,
            poly: {
                allowIntersection: false
            }
        },
        draw: {
            polygon: {
                allowIntersection: false,
                showArea: true
            },
            polyline: true,
            marker: true,
            circle: false,
            circlemarker: false,
            rectangle: false
        }
    });
    map.addControl(drawControl);

    // Obsługa zdarzenia po narysowaniu obiektu
    map.on(L.Draw.Event.CREATED, function (event) {
        const layer = event.layer;
        drawnItems.addLayer(layer);

        // Konwersja na GeoJSON i wysłanie na serwer
        const geoJSON = layer.toGeoJSON();
        saveGeometry(geoJSON);
    });

    // Funkcja do wysyłania geometrii
    async function saveGeometry(geoJSON) {
        try {
            const response = await fetch('{{ url_for('geomapper.save_geom') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ geometry: geoJSON.geometry })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            showToast(`Zapisano geometrię o ID: ${result.id}`);

        } catch (error) {
            console.error('Błąd zapisu geometrii:', error);
            showToast('Błąd zapisu geometrii.', true);
        }
    }

    // Funkcja do pokazywania powiadomień (toast)
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show';
        if (isError) {
            toast.classList.add('error');
        }
        setTimeout(() => {
            toast.className = toast.className.replace('show', '');
        }, 3000);
    }
});
</script>
{% endblock %}
